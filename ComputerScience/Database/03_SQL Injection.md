# SQL Injection
> 해커에 의해 조작된 SQL 쿼리문이 데이터 베이스에 그대로 전달되어 비정상적 명령을 실행시키는 공격 기법

<br>

## 공격 방법

### 1. 인증 우회 (논리적 에러를 이용한 SQL Injection)

보통 로그인을 할 때, 아이디와 비밀번호를 input 창에 입력하게 된다. 예를 들어 아이디가 abc, 비밀번호가 1234일 때 쿼리는 아래와 같은 방식으로 전송될 것이다.

```sql
SELECT *
FROM USER
WHERE ID = "abc"
AND PASSWORD = "1234";
```

SQL Injection으로 공격할 때, input 창에 비밀번호를 입력함과 동시에 다른 아래와 같은 쿼리문을 함께 입력하는 것이다.

```sql
" OR 1 = 1 --
```

```sql
SELECT *
  FROM USER
 WHERE ID = ""            -- WHERE 절을 true로 만들고
    OR 1 = 1
-- AND PASSWORD = "1234"  -- `--` 추가를 통해 주석 처리됩니다.

-- 결과 
SELECT * FROM USER
```

결과적으로 USER 테이블에 있는 모든 정보가 조회된다.  
그리고 가장 먼저 만들어진 계정으로 로그인에 성공하게 된다.  
-> 거의 맨 처음으로 관리자 계정을 생성하므로 그 권한을 통해 2차 피해가 발생한다.

<br>

### 2. 데이터 노출

시스템에서 발생하는 에러 메시지를 이용해 공격하는 방법이다.  
보통 에러를 통해 에러가 발생한 쿼리문과 함께 에러에 관한 내용을 반환받아 개발자가 버그를 수정하는 면에서 도움을 받는다.  
하지만 해커들은 이 부분을 이용해 악의적인 구문을 삽입하여 에러를 유발시킨다.<br><br>
예를 들면, 해커는 **GET 방식으로 동작하는 URL 쿼리 스트링을 추가하여 에러를 발생**시킨다.  
해당하는 오류가 발생하면, 이를 통해 해당 웹앱의 데이터베이스 구조를 유추할 수 있고 해킹에 활용한다.

<br>

## 방어 방법

### 1) input 값을 받을 때, 특수문자 여부 검사하기

> 로그인 전, 검증 로직을 추가하여 미리 설정한 특수문자들이 들어왔을 때 요청을 막아낸다.

<br>

### 2) SQL 서버 오류 발생 시, 해당하는 에러 메시지 감추기

> view를 활용하여 원본 데이터베이스 테이블에는 접근 권한을 높인다.  
일반 사용자는 사용자에게만 보여주는 페이지로만 접근하여 에러에 관한 내용을 볼 수 없도록 만든다.

<br>

### 3) preparestatement 사용하기

> - preparestatement를 사용하면, 특수문자를 자동으로 escaping 해준다.
> - 사용자의 입력 값이 데이터베이스의 파라미터로 들어가기 전에 DBMS가 미리 컴파일하여 실행하지 않고 대기한다. (쿼리문에서 전달인자 값을 `?`로 받는 것)  
-> 이를 활용해 사용자의 입력 값을 문자열로 인식하게 하여 공격쿼리가 들어간다고 하더라도, 사용자의 입력은 이미 의미 없는 단순 문자열이기 때문에 전체 쿼리문도 공격자의 의도대로 작동하지 않는다.

<br>

### 4) 웹 방화벽 사용

> - 웹 공격 방어에 특화되어있는 웹 방화벽을 사용하는 것도 하나의 방법이다.
> - 웹 방화벽은 소프트웨어 형, 하드웨어 형, 프록시 형 이렇게 세가지 종류로 나눠져 있다.  
    - 소프트웨어 형 : 서버 내에 직접 설치하는 방법  
    - 하드웨어 형 : 네트워크 상에서 서버 앞 단에 직접 하드웨어 장비로 구성하는 것  
    - 프록시 형 : DNS 서버 주소를 웹 방화벽으로 바꾸고 서버로 가는 트래픽이 웹 방화벽을 먼저 거치도록 하는 방법


<br>

##### [참고]
[SQL Injection 이란? (SQL 삽입 공격)](<https://noirstar.tistory.com/264>)
